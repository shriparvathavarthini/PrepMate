<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topic Selection - DSA Study Planner</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-code me-2"></i>DSA Study Planner
            </a>
            <div class="navbar-nav ms-auto">
                <a href="/dashboard" class="nav-link">
                    <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                </a>
                <button id="logoutBtn" class="btn btn-outline-secondary btn-sm ms-2">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="page-header p-4 rounded">
                    <h2 class="mb-2">Select Topics & Rate Your Skills</h2>
                    <p class="text-muted mb-0">Choose the DSA topics you want to study and rate your current skill level (1-5 scale)</p>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search topics...">
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-primary btn-sm filter-btn active" data-filter="all">
                        All Topics
                    </button>
                    <button class="btn btn-outline-success btn-sm filter-btn" data-filter="basic">
                        Basic
                    </button>
                    <button class="btn btn-outline-warning btn-sm filter-btn" data-filter="intermediate">
                        Intermediate
                    </button>
                    <button class="btn btn-outline-danger btn-sm filter-btn" data-filter="advanced">
                        Advanced
                    </button>
                </div>
            </div>
        </div>

        <!-- Topics Grid -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">DSA Topics</h5>
                        <div>
                            <span id="selectedCount" class="badge bg-primary me-2">0 selected</span>
                            <button id="selectAllBtn" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-check-double me-1"></i>Select All
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="topicsGrid" class="row">
                            <!-- Topics will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <button id="saveRatingsBtn" class="btn btn-success btn-lg me-3" disabled>
                    <i class="fas fa-save me-1"></i>Save Ratings
                </button>
                <button id="generatePlanBtn" class="btn btn-primary btn-lg" disabled>
                    <i class="fas fa-magic me-1"></i>Generate Study Plan
                </button>
            </div>
        </div>

        <!-- Loading Modal -->
        <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center py-4">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5 id="loadingText">Processing...</h5>
                        <p class="text-muted mb-0" id="loadingSubtext">Please wait</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "{{ firebase_api_key }}",
            authDomain: "{{ firebase_project_id }}.firebaseapp.com",
            projectId: "{{ firebase_project_id }}",
            storageBucket: "{{ firebase_project_id }}.firebasestorage.app",
            appId: "{{ firebase_app_id }}",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // DSA Topics with difficulty levels
        const topics = {
            'basic': [
                'Arrays', 'Strings', 'Sorting Algorithms', 'Searching Algorithms', 'Bit Manipulation'
            ],
            'intermediate': [
                'Linked Lists', 'Stacks', 'Queues', 'Hash Tables', 'Two Pointers', 
                'Binary Trees', 'Binary Search Trees', 'Heaps'
            ],
            'advanced': [
                'Graphs', 'Dynamic Programming', 'Greedy Algorithms', 'Backtracking',
                'Sliding Window', 'Trie', 'Union Find'
            ]
        };

        let currentRatings = {};
        let currentFilter = 'all';

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const idToken = await user.getIdToken();
                    await verifyToken(idToken);
                    await loadUserData();
                    initializeTopics();
                } catch (error) {
                    console.error('Authentication error:', error);
                    window.location.href = '/';
                }
            } else {
                window.location.href = '/';
            }
        });

        // Event listeners
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('searchInput').addEventListener('input', filterTopics);
        document.getElementById('selectAllBtn').addEventListener('click', selectAllTopics);
        document.getElementById('saveRatingsBtn').addEventListener('click', saveRatings);
        document.getElementById('generatePlanBtn').addEventListener('click', generateStudyPlan);

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentFilter = e.target.dataset.filter;
                filterTopics();
            });
        });

        async function verifyToken(idToken) {
            const response = await fetch('/api/verify-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken })
            });
            if (!response.ok) throw new Error('Token verification failed');
        }

        async function loadUserData() {
            try {
                const response = await fetch('/api/user-data');
                if (!response.ok) throw new Error('Failed to load user data');
                
                const data = await response.json();
                currentRatings = data.topic_ratings || {};
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function initializeTopics() {
            const grid = document.getElementById('topicsGrid');
            grid.innerHTML = '';

            Object.entries(topics).forEach(([difficulty, topicList]) => {
                topicList.forEach(topic => {
                    const col = document.createElement('div');
                    col.className = 'col-lg-4 col-md-6 mb-3 topic-item';
                    col.dataset.topic = topic.toLowerCase();
                    col.dataset.difficulty = difficulty;
                    
                    const currentRating = currentRatings[topic] || 0;
                    
                    col.innerHTML = `
                        <div class="card topic-card h-100" data-topic="${topic}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">${topic}</h6>
                                    <span class="badge ${getDifficultyBadgeClass(difficulty)}">${difficulty}</span>
                                </div>
                                <div class="rating-section mt-3">
                                    <label class="form-label small">Skill Level (1-5):</label>
                                    <div class="rating-stars" data-topic="${topic}">
                                        ${[1,2,3,4,5].map(rating => `
                                            <span class="star ${rating <= currentRating ? 'active' : ''}" 
                                                  data-rating="${rating}">â˜…</span>
                                        `).join('')}
                                    </div>
                                    <small class="text-muted rating-text">
                                        ${currentRating > 0 ? getRatingText(currentRating) : 'Click to rate'}
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    grid.appendChild(col);
                });
            });

            // Add rating event listeners
            document.querySelectorAll('.rating-stars .star').forEach(star => {
                star.addEventListener('click', handleRating);
            });

            updateSelectedCount();
        }

        function handleRating(e) {
            const rating = parseInt(e.target.dataset.rating);
            const topic = e.target.closest('.rating-stars').dataset.topic;
            const stars = e.target.closest('.rating-stars').querySelectorAll('.star');
            
            // Update visual state
            stars.forEach((star, index) => {
                star.classList.toggle('active', index < rating);
            });
            
            // Update rating text
            const ratingText = e.target.closest('.card-body').querySelector('.rating-text');
            ratingText.textContent = getRatingText(rating);
            
            // Update current ratings
            currentRatings[topic] = rating;
            
            updateSelectedCount();
            updateButtonStates();
        }

        function filterTopics() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const topicItems = document.querySelectorAll('.topic-item');
            
            topicItems.forEach(item => {
                const topicName = item.dataset.topic;
                const difficulty = item.dataset.difficulty;
                
                const matchesSearch = topicName.includes(searchTerm);
                const matchesFilter = currentFilter === 'all' || difficulty === currentFilter;
                
                item.style.display = matchesSearch && matchesFilter ? 'block' : 'none';
            });
        }

        function selectAllTopics() {
            const visibleCards = document.querySelectorAll('.topic-item:not([style*="display: none"]) .topic-card');
            
            visibleCards.forEach(card => {
                const topic = card.dataset.topic;
                if (!currentRatings[topic]) {
                    currentRatings[topic] = 3; // Default to intermediate level
                    
                    // Update visual state
                    const stars = card.querySelectorAll('.star');
                    stars.forEach((star, index) => {
                        star.classList.toggle('active', index < 3);
                    });
                    
                    const ratingText = card.querySelector('.rating-text');
                    ratingText.textContent = getRatingText(3);
                }
            });
            
            updateSelectedCount();
            updateButtonStates();
        }

        function updateSelectedCount() {
            const count = Object.keys(currentRatings).length;
            document.getElementById('selectedCount').textContent = `${count} selected`;
        }

        function updateButtonStates() {
            const hasRatings = Object.keys(currentRatings).length > 0;
            document.getElementById('saveRatingsBtn').disabled = !hasRatings;
            document.getElementById('generatePlanBtn').disabled = !hasRatings;
        }

        async function saveRatings() {
            try {
                showLoading('Saving Ratings', 'Saving your topic ratings...');
                
                const response = await fetch('/api/save-ratings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ratings: currentRatings })
                });
                
                if (!response.ok) throw new Error('Failed to save ratings');
                
                hideLoading();
                showSuccessAlert('Ratings saved successfully!');
                
            } catch (error) {
                hideLoading();
                console.error('Error saving ratings:', error);
                showErrorAlert('Failed to save ratings. Please try again.');
            }
        }

        async function generateStudyPlan() {
            try {
                showLoading('Generating Study Plan', 'Creating your personalized 7-day study plan...');
                
                const response = await fetch('/api/generate-plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate study plan');
                }
                
                const result = await response.json();
                hideLoading();
                
                showSuccessAlert('Study plan generated successfully!');
                setTimeout(() => {
                    window.location.href = '/study-plan';
                }, 1500);
                
            } catch (error) {
                hideLoading();
                console.error('Error generating study plan:', error);
                showErrorAlert(error.message || 'Failed to generate study plan. Please try again.');
            }
        }

        async function logout() {
            try {
                await signOut(auth);
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function getDifficultyBadgeClass(difficulty) {
            const classes = {
                'basic': 'bg-success',
                'intermediate': 'bg-warning',
                'advanced': 'bg-danger'
            };
            return classes[difficulty] || 'bg-secondary';
        }

        function getRatingText(rating) {
            const texts = {
                1: 'Beginner',
                2: 'Novice',
                3: 'Intermediate',
                4: 'Advanced',
                5: 'Expert'
            };
            return texts[rating] || '';
        }

        function showLoading(title, subtitle) {
            document.getElementById('loadingText').textContent = title;
            document.getElementById('loadingSubtext').textContent = subtitle;
            const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
            modal.show();
        }

        function hideLoading() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
            if (modal) modal.hide();
        }

        function showSuccessAlert(message) {
            showAlert(message, 'success');
        }

        function showErrorAlert(message) {
            showAlert(message, 'danger');
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
